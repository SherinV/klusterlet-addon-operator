# Licensed Materials - Property of IBM
# @ Copyright IBM Corporation 2016, 2019. All Rights Reserved.
# US Government Users Restricted Rights - Use, duplication or disclosure restricted by GSA ADP Schedule Contract with IBM Corp.

apiVersion: v1
kind: Pod
metadata:
  labels:
    app: metering-test
    chart: {{ .Chart.Name }}
    component: metering
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
    app.kubernetes.io/name: metering-dm
    app.kubernetes.io/component: meteringsvc
    app.kubernetes.io/managed-by: "{{ .Release.Service }}"
    helm.sh/chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    app.kubernetes.io/instance: "{{ .Release.Name }}"
  name: metering-test
  annotations:
    "helm.sh/hook": test-success
spec:
  hostPID: false
  hostIPC: false
  hostNetwork: false
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
            - key: beta.kubernetes.io/arch
              operator: In
              values:
              {{- if .Values.arch }}
              - {{ .Values.arch }}
              {{- else }}
              - {{ template "metering.arch" . }}
              {{- end }}  
  containers:
    - name: "metering-test"
      image: "{{ .Values.dm.image.repository }}:{{ .Values.dm.image.tag }}"
      imagePullPolicy: "{{ .Values.dm.image.pullPolicy }}"
      securityContext:
        runAsNonRoot: true
{{- if not (.Capabilities.APIVersions.Has "security.openshift.io/v1") }}
        runAsUser: {{ .Values.runAsUser }}
{{- end }}
        privileged: false
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: true
        capabilities:
          drop:
          - ALL
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 100m
          memory: 256Mi
      command: ['/bin/bash', '-c']
      args: ['curl -kf http://metering-dm:3000/readinessProbe && curl -kf http://metering-server:4000/api/swagger && curl -kf http://metering-ui:3130/unsecure/c2c/status/readinessProbe']
  restartPolicy: Never