overrides: 
- rule: NoICPReferences
  severity: REVIEW
  reduceTo: INFO
  filenames: [ README.md ]
  message: "\"icp\" not allowed"
  reason: "The instances of icp appear in defaults in the values.yaml table.  These cannot be changed since it would break upgrade."

- rule: ManifestImagesAreUsed
  severity: REVIEW
  reduceTo: INFO
  filenames: [ ibm_cloud_pak/manifest.yaml ]
  #message: "ibm_cloud_pak/manifest.yaml: image is not used: 'metering-data-manager:3.2.1'"
  # also instances for metering-mcmui:3.2.1, metering-ui:3.2.1
  message: "ibm_cloud_pak/manifest.yaml: image"
  reason: "The CICD process updates the chart with the final image tags (which are latest throughout development until ship) so the image names won't match the manifest"

- rule: NoSensitiveInfoInValues
  severity: REVIEW
  reduceTo: INFO
  filenames: [ values.yaml ]
  # 19 instances in values.yaml - dm.tolerations[0].key dm.tolerations[1].key mcmui.tolerations[0].key mcmui.tolerations[1].key mongo.clientcertssecret mongo.clustercertssecret mongo.password mongo.password.key mongo.password.secret mongo.username.keymongo.username.secret reader.tolerations[0].key reader.tolerations[1].key secretcheck sender.hubKubeConfigSecret sender.tolerations[0].key sender.tolerations[1].key ui.tolerations[0].key ui.tolerations[1].key
  message: "potentially secret parameter"
  reason: "None of the fields indicated have sensitive information.  It is toleration settings and the locations of secrets and keys within them."

- rule: MonitoringDashboardExists
  severity: WARNING
  reduceTo: INFO
  filenames: [ Chart.yaml ]
  message: "monitoring dashboard resource of kind \"MonitoringDashboard\" and apiVersion \"monitoringcontroller.cloud.ibm.com/v1\" not found"
  reason: "This is an internal ICP chart rather than an external product and does not contain a sample dashboard built-in"


- rule: ContainerImageNameIsValid
  severity: WARNING
  reduceTo: INFO
  filenames: [ ibm_cloud_pak/manifest.yaml ]
  # 9 instances
  message: "invalid arch \"\""
  reason: "We are not currently available in the entitled registry ... still trying to find out what the plans are there since metering is a common service"

- rule: ParameterIsCamelCase
  severity: WARNING
  reduceTo: INFO
  filenames: [ values.yaml ] 
  # 7 instances: 'external.cluster_ip', 'external.cluster_name', 'external.cluster_port', 'serviceport.iam_pap', 'serviceport.iam_token', 'serviceport.platform_header', 'serviceport.platform_identity_management'
  message: "to be camelCase"
  reason: "Changing parameters would break image and conflict with previous releases"

- rule: IBMInName
  severity: ERROR
  reduceTo: INFO
  message: "expected name to begin with \"ibm-\""
  reason: "Changing chart name could cause problems in upgrade and rollback."

- rule: ChartNameVersionClassificationMatch
  severity: ERROR
  reduceTo: INFO
  filenames: [ Chart.yaml ] 
  message: "expected chart with the Commercial keyword and no Limited keyword to have a name ending in \"-prod\""
  reason: "The metering chart is Commercial, but the chart name does not include prod. Changing chart name could cause problems in upgrade and rollback"

- rule: ChartNameVersionClassificationMatch
  severity: ERROR
  reduceTo: INFO
  filenames: [ Chart.yaml ] 
  message: "expected chart without name ending in \"-dev\" or \"-prod\" to have both the Commercial and Limited keywords"
  reason: "The metering chart is Commercial so the Limited keyword was removed, but the chart name does not include prod. Changing chart name could cause problems in upgrade and rollback"

- rule: AppTestExists
  severity: ERROR
  reduceTo: INFO
  filenames: [ cv-tests ]
  message: "no application tests defined"
  reason: "Organizational decision to remain with existing testing infrastructure rather than transfer to helm testing"

- rule: IngressRuleHasHost
  severity: REVIEW
  reduceTo: INFO
  filenames: [ templates/metering-api-check-ingress.yaml, templates/metering-api-ingress.yaml, templates/metering-api-swagger-ingress.yaml, templates/metering-mcmui-ingress.yaml, templates/metering-ui-ingress.yaml ]
  message: "host not defined"
  reason: "By default we wanted the ingress to match all hosts so no value is provided, however we wanted to leave the opportunity to update it during install if required."

- rule: NoIngressCollisions
  severity: WARNING
  reduceTo: INFO
  filenames: [ templates/metering-api-check-ingress.yaml, templates/metering-api-ingress.yaml, templates/metering-api-swagger-ingress.yaml, templates/metering-mcmui-ingress.yaml, templates/metering-ui-ingress.yaml ] 
  # Trimmed message so the over-ride matches
  #message: "expected spec.rules[0].http.paths[0] to be parameterized because spec.rules[0].host is blank"
  message: " to be parameterized because "
  reason: "Ingress host is configurable if so desired in the unlikely case of a collision. Metering only supports a single instance so collisions are unlikely"

- rule: NoDuplicateIngressRuleHosts
  severity: WARNING
  reduceTo: INFO
  # The full message text was not matching for over-ride
  #message: 'host "" not allowed in multiple Ingress rules at templates/metering-api-check-ingress.yaml:spec.rules[0].host, templates/metering-api-ingress.yaml:spec.rules[0].host, templates/metering-api-swagger-ingress.yaml:spec.rules[0].host, templates/metering-mcmui-ingress.yaml:spec.rules[0].host, templates/metering-ui-ingress.yaml:spec.rules[0].host'
  message: "host \"\" not allowed in multiple Ingress rules at "
  reason: "No host used, rule applies to all inbound HTTP traffic through the IP address specified"
  
- rule: NoDefaultServiceAccountName
  severity: REVIEW
  reduceTo: INFO
  filenames: [templates/metering-dm-deployment.yaml, templates/metering-mcmui-deployment.yaml, templates/metering-reader-daemonset.yaml, templates/metering-ui-deployment.yaml, "templates/metering-sender.yaml", templates/tests/metering-test.yaml]
  message: "serviceAccountName not defined"
  reason: "We don't create a custom service account to assign or use."

- rule: NoPrivateIAMEndpoints
  severity: ERROR
  reduceTo: INFO
  filenames: [ templates/metering-ui-deployment.yaml ] 
  # Could not use the full message 
  #message: "use of https://metering-server:9443, https://platform-identity-provider:4300 in rendered template to access IAM APIs not allowed, use the management ingress at https://<cluster_CA_domain>:8443/<api> or https://icp-management-ingress.kube-system:8443/<api> instead"
  message: "in rendered template to access IAM APIs not allowed, use the management ingress at"
  reason: "This config is for the security middleware component delivered by IAM.  Internal IAM endpoints will be updated for the ingress in the future."
- rule: NoPrivateIAMEndpoints
  severity: ERROR
  reduceTo: INFO
  filenames: [ templates/metering-ui-deployment.yaml ] 
  # Could not use the full message
  #message: "use of https://metering-server:9443, https://platform-identity-provider:4300 to access IAM APIs not allowed, use the management ingress at https://<cluster_CA_domain>:8443/<api> or https://icp-management-ingress.kube-system:8443/<api> instead"
  message: "to access IAM APIs not allowed, use the management ingress"
  reason: "This config is for the security middleware component delivered by IAM.  Internal IAM endpoints will be updated for the ingress in the future."
- rule: NoPrivateIAMEndpoints
  severity: ERROR
  reduceTo: INFO
  filenames: [ cv-tests/lintOverrides.yaml ] 
  # Could not use the full message
  #message: "use of https://metering-server:9443, https://platform-identity-provider:4300 to access IAM APIs not allowed, use the management ingress at https://<cluster_CA_domain>:8443/<api> or https://icp-management-ingress.kube-system:8443/<api> instead"
  message: "to access IAM APIs not allowed, use the management ingress"
  reason: "This config is for the security middleware component delivered by IAM.  Internal IAM endpoints will be updated for the ingress in the future."

- rule: CustomPodSecurityInReadme
  severity: ERROR
  reduceTo: INFO
  filenames: [ README.md ]
  # Trimmed message so over-ride matches
  #message: 'required custom pod security definition not found using regex "(?i)Custom PodSecurityPolicy definition:\\s+```"'
  message: 'required custom pod security definition not found using regex '
  reason: "There is an ibm pod security policy specified, a custom policy is not necessary"

- rule: UsedParametersAreDefined
  severity: REVIEW
  reduceTo: INFO
  message: "parameter is used but not defined: .Values.imagePullSecrets"
  reason: "Not currently used with normal chart installation so it is not defined.  The value is set via an operator deployment by the klusterlet component operator."

- rule: UsedParametersAreDefined
  severity: REVIEW
  reduceTo: INFO
  message: "parameter is used but not defined: .Values.affinity"
  reason: "Not currently used with normal chart installation so it is not defined.  The value is set via an operator deployment by the klusterlet component operator."

- rule: RequiredMetadataLabelsDefined
  severity: ERROR
  reduceTo: INFO
  filenames: [ templates/metering-receiver-certificate.yaml, templates/metering-api-certificate.yaml, templates/config_data.yaml ]
  # Trimmed message so over-ride matches
  #message: '["app.kubernetes.io/instance" "app.kubernetes.io/managed-by" "app.kubernetes.io/name" "helm.sh/chart"] not defined under metadata.labels'
  message: ' not defined under metadata.labels'
  reason: "Moving to new helm labels would break upgrade and rollback per the helm team"

- rule: PodDisruptionBudgetInReadme
  severity: WARNING
  reduceTo: INFO
  filenames: [ README.md ]
  message: "no preinstall steps found for PodDisruptionBudgets in Prerequisites of README"
  reason: "Metering is a single instance stateful application and can tolerate occassional downtime.  We will explore a pod disruption budget for the reader component, but don't feel its necessary at this time."

- rule: NoDeprecatedAPIs
  severity: ERROR
  reduceTo: INFO
  filenames: [ templates/metering-api-check-ingress.yaml, templates/metering-api-ingress.yaml, templates/metering-api-swagger-ingress.yaml, templates/metering-mcmui-ingress.yaml, templates/metering-ui-ingress.yaml ]
  # Trimmed message so over-ride matches
  #message: 'apiVersion "extensions/v1beta1" is deprecated on resource "Ingress" and will be removed in Kubernetes 1.20, switch to apiVersion "networking.k8s.io/v1beta1" served since Kubernetes 1.14'
  message: 'apiVersion "extensions/v1beta1" is deprecated on resource "Ingress" and will be removed in Kubernetes 1.20, switch to apiVersion "networking.k8s.io/v1beta1" served since Kubernetes 1.14'
  reason: "Adopting the new apiVersion impacts upgrade as we may be upgrading from 1.13 systems."

- rule: MeteringAnnotationsDefined
  severity: ERROR
  reduceTo: INFO
  filenames: [ templates/metering-dm-deployment.yaml, templates/metering-mcmui-deployment.yaml, templates/metering-reader-daemonset.yaml, templates/metering-ui-deployment.yaml, templates/metering-sender.yaml ]
  # Trimmed message so over-ride matches
  #message: 'metering annotations ["productID" "productName" "productVersion"] not found under spec.template.metadata.annotations'
  message: 'not found under spec.template.metadata.annotations'
  reason: "Unresolved legal and technical issues, so decision was made to remove annotations for common services"

- rule: TranslatedLicenseLinkExists
  severity: ERROR
  reduceTo: INFO
  filenames: [ LICENSES ]
  message: 'no link to translated licenses found of the form "The translated license terms can be viewed here'
  reason: "Per common services release manager - The Master license (eg. at the offering level) will have translated licenses. We'll need to override for this release and see how better to work around it in the next release."

#RECHEK ==================================================================

- rule: UseEntitledRegistry
  severity: WARNING
  reduceTo: INFO
  filenames: [ ibm_cloud_pak/manifest.yaml ]
  # 9 instances
  message: "recommend using entitled registry path and namespace \"cp.icr.io/cp\""
  reason: "We are not currently available in the entitled registry ... still trying to find out what the plans are there since metering is a common service"
