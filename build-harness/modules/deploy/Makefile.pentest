PENTEST_GITHUB_USER ?= $(GITHUB_USER)
PENTEST_GITHUB_TOKEN ?= $(GITHUB_TOKEN)
PENTEST_GIT_TF_DEPLOY_PROJECT ?= "https://$(PENTEST_GITHUB_USER):$(PENTEST_GITHUB_TOKEN)@github.ibm.com/ICP-DevOps/tf_icp_os.git"
PENTEST_GIT_TF_DEPLOY_BRANCH ?= master
PENTEST_DEPLOY_DIR := .pentest.deploy/
PENTEST_TERRAFORM_VARS_FILE := .pentest.tfvars

.PHONY: deploy\:pentest
## Deploy pentest build
deploy\:pentest:
	@$(GIT) clone -b $(PENTEST_GIT_TF_DEPLOY_BRANCH) $(PENTEST_GIT_TF_DEPLOY_PROJECT) $(PENTEST_DEPLOY_DIR)
	@$(SELF) deploy:openstack-kp OPENSTACK_KP_TERRAFORM_VARS_FILE=$(PENTEST_TERRAFORM_VARS_FILE)
	@$(SELF) terraform:apply TERRAFORM_VARS_FILE=$(PENTEST_TERRAFORM_VARS_FILE) TERRAFORM_DIR=$(PENTEST_DEPLOY_DIR)

.PHONY: deploy\:pentest\:destroy
## Destroy pentest deployment resources
deploy\:pentest\:destroy:
	@$(SELF) terraform:destroy TERRAFORM_VARS_FILE=$(PENTEST_TERRAFORM_VARS_FILE) TERRAFORM_DIR=$(PENTEST_DEPLOY_DIR)

.PHONY: deploy\:pentest\:clean
## Clean up all pentest deployment resources
deploy\:pentest\:clean: %clean: %destroy
ifeq ($(shell test -d $(PENTEST_DEPLOY_DIR) && echo -n yes),yes)
	@rm -rf $(PENTEST_DEPLOY_DIR)
endif